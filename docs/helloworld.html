<!doctype html>
<html lang="en">

<script>
    // ====== EDIT ME: PAGES ======
    const PAGES = [
        "https://www.dropbox.com/scl/fi/8cj3hs48bcw4zojombs1f/_COVER_.png?rlkey=uzggyz7cuzz4k8i6udyj8g4s9&st=ovvncoo3&raw=1",
        "https://www.dropbox.com/scl/fi/ly4h34jvxx59qlij0lgm5/Page_1.png?rlkey=1wlliz7gg2jjt42gh5sakjz3l&st=f3y5sxum&raw=1",
        "https://www.dropbox.com/scl/fi/6hathoea5xu7nw6c0qdp1/Page_2.png?rlkey=4jtrumlnzue02dq9dllg8pyr6&st=sc77xcck&raw=1",
        "https://www.dropbox.com/scl/fi/5lrouobfyg5o93oehjllr/Page_3.png?rlkey=alnf1z19p3llnue8vofxyz92t&st=0yle1wcs&raw=1",
        "https://www.dropbox.com/scl/fi/yywoj33djkaxbr7nazcw4/Page_4.png?rlkey=udep490jn2vwxmt73ghkk0r1b&st=c6m4dkxk&raw=1",
        "https://www.dropbox.com/scl/fi/m31n8mpggfuju7kjc7ylx/Page_5.png?rlkey=bhnt2n786wb14s9utr1wz159b&st=g4iw5e6p&raw=1"
    ];
    const BOOK = {
        title: "Your Book Title",
        readingDirection: "rtl",
        startPage: 1
    };
    // ============================
</script>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="color-scheme" content="dark light">
    <title>Neo-Blue Comic Reader</title>
    <style>
        :root {
            --bg: #0a0f1a;
            --bg2: #0d1526;
            --panel: rgba(18, 27, 46, .72);
            --panel2: rgba(22, 33, 58, .9);
            --txt: #e7eefc;
            --mut: #a9b9d6;
            --pri: #4ea1ff;
            --pri2: #6ac0ff;
            --ok: #56f0a5;
            --bad: #ff6b6b;
            --ring: 0 0 0 1px rgba(255, 255, 255, .08), 0 8px 24px rgba(0, 0, 0, .45);
            --shadow: 0 8px 22px rgba(0, 0, 0, .35);
            --glass: blur(10px) saturate(120%);
            --r: 14px;
            --r2: 20px
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 70% -20%, rgba(78, 161, 255, .12), transparent 60%), var(--bg);
            color: var(--txt);
            font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            overflow: hidden
        }

        a {
            color: var(--pri)
        }

        .top {
            position: fixed;
            inset: 0 0 auto 0;
            height: 56px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--panel);
            backdrop-filter: var(--glass);
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            box-shadow: var(--ring);
            z-index: 30
        }

        .logo {
            width: 26px;
            height: 26px;
            border-radius: 8px;
            background: radial-gradient(120% 120% at 10% 10%, var(--pri), #00d2ff 70%, transparent 71%), linear-gradient(180deg, rgba(255, 255, 255, .15), rgba(255, 255, 255, 0));
            filter: drop-shadow(0 0 10px rgba(78, 161, 255, .35))
        }

        .title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .pill {
            padding: .3rem .55rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .08)
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: .42rem .65rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .08);
            cursor: pointer;
            user-select: none;
            box-shadow: var(--ring)
        }

        .btn:hover {
            background: rgba(255, 255, 255, .09)
        }

        .btn:active {
            transform: translateY(1px) scale(.98)
        }

        .btn[aria-pressed="true"] {
            box-shadow: 0 0 0 2px rgba(78, 161, 255, .45) inset, var(--ring)
        }

        .wrap {
            position: absolute;
            inset: 56px 0 86px 0;
            display: flex
        }

        .side {
            width: 168px;
            max-width: 280px;
            border-right: 1px solid rgba(255, 255, 255, .06);
            background: var(--panel);
            backdrop-filter: var(--glass);
            box-shadow: var(--ring);
            overflow: auto;
            scroll-behavior: smooth
        }

        .side[hidden] {
            display: none !important
        }

        .thumbs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            padding: 10px
        }

        .th {
            position: relative;
            border-radius: 12px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .08);
            overflow: hidden;
            cursor: pointer;
            box-shadow: var(--shadow)
        }

        .th::after {
            content: attr(data-p);
            position: absolute;
            top: 6px;
            left: 6px;
            font-size: 11px;
            background: rgba(0, 0, 0, .45);
            padding: .15rem .35rem;
            border-radius: 999px
        }

        .th[aria-current="true"] {
            box-shadow: 0 0 0 2px var(--pri) inset, var(--ring)
        }

        .th img {
            width: 100%;
            display: block;
            aspect-ratio: .707/1;
            object-fit: cover
        }

        .ske {
            background: #111;
            background-image: linear-gradient(90deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .12), rgba(255, 255, 255, .05));
            background-size: 400% 100%;
            animation: sh 2s infinite linear
        }

        @keyframes sh {
            0% {
                background-position: 0 0
            }

            100% {
                background-position: 100% 0
            }
        }

        .vp {
            position: relative;
            flex: 1;
            overflow: hidden
        }

        .stage {
            position: absolute;
            inset: 0;
            overflow: auto;
            display: flex;
            align-items: flex-start;
            justify-content: center
        }

        .pages {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            transform-origin: top center
        }

        .page {
            position: relative;
            background: rgba(255, 255, 255, .02);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            max-width: none;
            max-height: none
        }

        .page img {
            display: block;
            width: auto;
            height: auto;
            max-width: none;
            max-height: none;
            object-fit: contain;
            background: #0b1221
        }

        .err {
            position: absolute;
            inset: auto 8px 8px 8px;
            background: rgba(0, 0, 0, .65);
            padding: .6rem .8rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .12);
            display: none
        }

        .page[data-e="1"] .err {
            display: block
        }

        .cont {
            position: relative;
            inset: auto;
            overflow: visible;
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px
        }

        .cont figure {
            background: rgba(255, 255, 255, .02);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow)
        }

        .cont img {
            width: 100%;
            height: auto;
            display: block;
            background: #0b1221
        }

        .dock {
            position: fixed;
            inset: auto 0 0 0;
            height: 86px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--panel);
            backdrop-filter: var(--glass);
            border-top: 1px solid rgba(255, 255, 255, .06);
            box-shadow: var(--ring);
            z-index: 30
        }

        .grp {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 12px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .06)
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 240px;
            height: 4px;
            background: rgba(255, 255, 255, .15);
            border-radius: 999px;
            outline: none
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--pri);
            box-shadow: 0 0 0 2px rgba(0, 0, 0, .2)
        }

        input[type=number],
        select {
            padding: .45rem .6rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            color: var(--txt)
        }

        input[type=number] {
            width: 70px
        }

        .overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 50
        }

        .overlay[open] {
            display: block
        }

        .veil {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            backdrop-filter: blur(2px)
        }

        .panel {
            position: absolute;
            inset: 10% max(10px, min(25vw, 420px)) 10% max(10px, min(25vw, 420px));
            background: var(--panel2);
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 18px;
            box-shadow: var(--ring);
            overflow: auto
        }

        .panel header {
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, rgba(22, 33, 58, .95), rgba(22, 33, 58, .8));
            border-bottom: 1px solid rgba(255, 255, 255, .08);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .panel .content {
            padding: 14px
        }

        .sidebtn {
            position: fixed;
            left: 6px;
            top: 64px;
            z-index: 31
        }

        .chrome-hidden .top,
        .chrome-hidden .dock,
        .chrome-hidden .sidebtn {
            opacity: 0;
            pointer-events: none
        }

        :focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(78, 161, 255, .6)
        }

        /* Hide scrollbars but keep scrolling (cross-browser) */
        .stage,
        .side,
        .cont {
            -ms-overflow-style: none;
            /* IE/Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .stage::-webkit-scrollbar,
        .side::-webkit-scrollbar,
        .cont::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        body.mode-cont .pages {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- (icons omitted here for brevity — unchanged from your version) -->
    <!-- ... your SVG <defs> block from the original code goes here unchanged ... -->
    <svg width="0" height="0" style="position:absolute;visibility:hidden">
        <!-- defs exactly as in your post -->
        <defs>
            <!-- ... (unchanged icons) ... -->
            <symbol id="i-prev" viewBox="0 0 24 24">
                <path fill="currentColor" d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
            </symbol>
            <symbol id="i-next" viewBox="0 0 24 24">
                <path fill="currentColor" d="M8.59 16.59 10 18l6-6-6-6-1.41 1.41L13.17 12z" />
            </symbol>
            <symbol id="i-zoomin" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 9.5 16c1.6 0 3.1-.6 4.2-1.6l.3.3v.8l5 5 1-1-5-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14zm1-7h-2v2H6v2h2v2h2v-2h2V9z" />
            </symbol>
            <symbol id="i-zoomout" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 9.5 16c1.6 0 3.1-.6 4.2-1.6l.3.3v.8l5 5 1-1-5-5zM7 10h5v1H7z" />
            </symbol>
            <symbol id="i-full" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M7 14H5v5h5v-2H7v-3zm0-4h3V7h2V5H5v5h2zm10 9h-3v2h5v-5h-2v3zm0-14h-3V3h5v5h-2V5z" />
            </symbol>
            <symbol id="i-fit" viewBox="0 0 24 24">
                <path fill="currentColor" d="M4 6h16v12H4zM6 8v8h12V8z" />
            </symbol>
            <symbol id="i-h" viewBox="0 0 24 24">
                <path fill="currentColor" d="M11 5h2v14h-2zm-4 4 4-4 4 4H7zm0 6h8l-4 4-4-4z" />
            </symbol>
            <symbol id="i-w" viewBox="0 0 24 24">
                <path fill="currentColor" d="M19 11v2H5v-2zm-4 4 4-4-4-4v8zM9 7 5 11l4 4V7z" />
            </symbol>
            <symbol id="i-orig" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="2" />
            </symbol>
            <symbol id="i-two" viewBox="0 0 24 24">
                <path fill="currentColor" d="M5 5h6v14H5zm8 0h6v14h-6z" />
            </symbol>
            <symbol id="i-one" viewBox="0 0 24 24">
                <path fill="currentColor" d="M6 5h12v14H6z" />
            </symbol>
            <symbol id="i-scroll" viewBox="0 0 24 24">
                <path fill="currentColor" d="M7 2h10v2H7zM5 6h14v2H5zm0 4h14v2H5zm0 4h14v2H5zm2 4h10v2H7z" />
            </symbol>
            <symbol id="i-rtl" viewBox="0 0 24 24">
                <path fill="currentColor" d="M7 4h8a4 4 0 1 1 0 8H9v8H7zM19 12v8h-2v-8z" />
            </symbol>
            <symbol id="i-thumbs" viewBox="0 0 24 24">
                <path fill="currentColor" d="M4 4h4v16H4zm6 3h10v10H10z" />
            </symbol>
            <symbol id="i-bm" viewBox="0 0 24 24">
                <path fill="currentColor" d="M6 4h12v16l-6-3-6 3z" />
            </symbol>
            <symbol id="i-settings" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M19.1 12.9a8 8 0 0 0 0-1.8l2-1.6-1.9-3.3-2.4 1a7 7 0 0 0-1.6-.9L14.9 3h-3.8l-.3 2.3a7 7 0 0 0-1.6.9l-2.4-1L4.9 8.6l2 1.6a8 8 0 0 0 0 1.8l-2 1.6 1.9 3.3 2.4 1a7 7 0 0 0 1.6.9l.3 2.3h3.8l.3-2.3a7 7 0 0 0 1.6-.9l2.4 1 1.9-3.3-2-1.6zM12 15.5A3.5 3.5 0 1 1 15.5 12 3.5 3.5 0 0 1 12 15.5z" />
            </symbol>
            <symbol id="i-help" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 17h-2v-2h2zm1.1-7.8-.9.9a1.5 1.5 0 0 0-.4 1.4H11v-1h1.5a.5.5 0 0 0 .4-.8l-1.2-1.2A2.5 2.5 0 1 1 15 8.5a2.5 2.5 0 0 1-.9 1.7z" />
            </symbol>
            <symbol id="i-rot" viewBox="0 0 24 24">
                <path fill="currentColor" d="M15.6 5.6A7 7 0 1 0 5.6 15.5H3l3.9 3.9 3.9-3.9H8.2a5 5 0 1 1 7.4-7.4z" />
            </symbol>
            <symbol id="i-dl" viewBox="0 0 24 24">
                <path fill="currentColor" d="M5 20h14v-2H5m7-14v8l3.5-3.5 1.4 1.4L12 18 7.1 13.1 8.5 11.7 12 15V4z" />
            </symbol>
            <symbol id="i-ui" viewBox="0 0 24 24">
                <path fill="currentColor" d="M3 5h18v4H3zm0 5h12v9H3zm14 0h4v9h-4z" />
            </symbol>
        </defs>
    </svg>

    <!-- Top bar, sidebar, viewport, dock: unchanged from your code -->
    <div class="top" role="toolbar" aria-label="Top bar">
        <div class="logo" aria-hidden="true"></div>
        <div class="title" id="t">Comic Reader</div>
        <div style="flex:1"></div>
        <div class="pill" id="kpiP">Page 1/1</div>
        <div class="pill" id="kpiZ">100%</div>
        <button class="btn" id="fs" aria-label="Fullscreen"><svg width="18" height="18">
                <use href="#i-full" />
            </svg>Fullscreen</button>
    </div>
    <button class="btn sidebtn" id="thumbToggle" aria-pressed="false" aria-label="Toggle thumbnails"><svg width="18"
            height="18">
            <use href="#i-thumbs" />
        </svg></button>
    <div class="wrap">
        <aside class="side" id="side" aria-label="Thumbnails" hidden>
            <div class="thumbs" id="thumbs"></div>
        </aside>
        <main class="vp" id="vp" aria-live="polite">
            <div class="stage" id="stage">
                <div class="pages" id="pages">
                    <figure class="page" id="pA"><img alt="Page" id="iA">
                        <figcaption class="err" id="eA"></figcaption>
                    </figure>
                    <figure class="page" id="pB" hidden><img alt="Page" id="iB">
                        <figcaption class="err" id="eB"></figcaption>
                    </figure>
                </div>
                <div class="cont" id="cont" hidden></div>
            </div>
        </main>
    </div>
    <div class="dock" role="toolbar" aria-label="Controls">
        <div class="grp"><button class="btn" id="prev" aria-label="Previous"><svg width="18" height="18">
                    <use href="#i-prev" />
                </svg>Prev</button><button class="btn" id="next" aria-label="Next"><svg width="18" height="18">
                    <use href="#i-next" />
                </svg>Next</button></div>
        <div class="grp"><input type="range" id="rng" min="1" max="1" value="1" aria-label="Page slider"><input
                type="number" id="jmp" min="1" value="1" aria-label="Go to page"></div>
        <div class="grp"><button class="btn" id="fitBest"><svg width="18" height="18">
                    <use href="#i-fit" />
                </svg>Best</button><button class="btn" id="fitW"><svg width="18" height="18">
                    <use href="#i-w" />
                </svg>Width</button><button class="btn" id="fitH"><svg width="18" height="18">
                    <use href="#i-h" />
                </svg>Height</button><button class="btn" id="fitO"><svg width="18" height="18">
                    <use href="#i-orig" />
                </svg>Original</button><button class="btn" id="rot"><svg width="18" height="18">
                    <use href="#i-rot" />
                </svg>Rotate</button></div>
        <div class="grp"><button class="btn" id="z-" aria-label="Zoom out"><svg width="18" height="18">
                    <use href="#i-zoomout" />
                </svg></button><button class="btn" id="z+" aria-label="Zoom in"><svg width="18" height="18">
                    <use href="#i-zoomin" />
                </svg></button></div>
        <div class="grp"><button class="btn" id="dbl" aria-pressed="false"><svg width="18" height="18">
                    <use href="#i-two" />
                </svg>Double</button><button class="btn" id="scroll" aria-pressed="false"><svg width="18" height="18">
                    <use href="#i-scroll" />
                </svg>Continuous</button><button class="btn" id="rtl" aria-pressed="false"><svg width="18" height="18">
                    <use href="#i-rtl" />
                </svg>Manga</button><button class="btn" id="ui" aria-pressed="false"><svg width="18" height="18">
                    <use href="#i-ui" />
                </svg>UI</button></div>
        <div class="grp"><button class="btn" id="bm"><svg width="18" height="18">
                    <use href="#i-bm" />
                </svg>Bookmarks</button><button class="btn" id="st"><svg width="18" height="18">
                    <use href="#i-settings" />
                </svg>Settings</button><button class="btn" id="hlp"><svg width="18" height="18">
                    <use href="#i-help" />
                </svg>Help</button><button class="btn" id="dl"><svg width="18" height="18">
                    <use href="#i-dl" />
                </svg>Download</button></div>
    </div>

    <div class="overlay" id="ovHelp" role="dialog" aria-labelledby="hTitle">
        <div class="veil" data-close="#ovHelp"></div>
        <div class="panel">
            <header>
                <h2 id="hTitle">Keyboard & Gestures</h2><button class="btn" data-close="#ovHelp">Close</button>
            </header>
            <div class="content" id="helpC"></div>
        </div>
    </div>
    <div class="overlay" id="ovSet" role="dialog" aria-labelledby="sTitle">
        <div class="veil" data-close="#ovSet"></div>
        <div class="panel">
            <header>
                <h2 id="sTitle">Settings</h2><button class="btn" data-close="#ovSet">Close</button>
            </header>
            <div class="content" id="setC"></div>
        </div>
    </div>
    <div class="overlay" id="ovBm" role="dialog" aria-labelledby="bTitle">
        <div class="veil" data-close="#ovBm"></div>
        <div class="panel">
            <header>
                <h2 id="bTitle">Bookmarks</h2><button class="btn" data-close="#ovBm">Close</button>
            </header>
            <div class="content">
                <div id="bmList" class="thumbs" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr))"></div>
            </div>
        </div>
    </div>
    <div class="overlay" id="ovCmd" role="dialog" aria-labelledby="cTitle">
        <div class="veil" data-close="#ovCmd"></div>
        <div class="panel">
            <header>
                <h2 id="cTitle">Go to Page</h2><button class="btn" data-close="#ovCmd">Close</button>
            </header>
            <div class="content">
                <p>Type a page number or <code>p:12</code>, then Enter.</p><input type="number" id="cmdIn" min="1"
                    style="width:160px">
            </div>
        </div>
    </div>

    <template id="file-help.html">
        <section>
            <h3>Keyboard</h3>
            <ul>
                <li><b>←/→</b> Prev/Next (respects RTL)</li>
                <li><b>[</b>/<b>]</b> −/+10 pages</li>
                <li><b>+</b>/<b>-</b> Zoom in/out</li>
                <li><b>0</b> Fit Width, <b>9</b> Fit Height, <b>8</b> Original</li>
                <li><b>F</b> Fullscreen, <b>T</b> Thumbs, <b>C</b> Continuous, <b>D</b> Double</li>
                <li><b>M</b> Manga RTL, <b>R</b> Rotate, <b>B</b> Bookmark</li>
                <li><b>H</b> Help, <b>G</b> Toggle UI, <b>/</b> Command</li>
            </ul>
            <h3>Gestures</h3>
            <ul>
                <li>Pinch to zoom, drag to pan when zoomed</li>
                <li>Tap toggles chrome, swipe left/right to navigate</li>
                <li>Double-tap/click toggles zoom</li>
            </ul>
        </section>
    </template>

    <template id="file-settings.html">
        <form id="setForm">
            <label>Fit:
                <select name="fit">
                    <option value="best">Best</option>
                    <option value="width">Width</option>
                    <option value="height">Height</option>
                    <option value="orig">Original</option>
                </select>
            </label>
            <br><br>
            <label>Best fit strategy:
                <select name="bestStrategy">
                    <option value="contain">Contain (no scroll)</option>
                    <option value="width" selected>Fill width</option>
                    <option value="height">Fill height</option>
                    <option value="smart">Smart (portrait→width)</option>
                </select>
            </label>
            <br><br>
            <label><input type="checkbox" name="double"> Double-page</label><br>
            <label><input type="checkbox" name="continuous"> Continuous scroll</label><br>
            <label><input type="checkbox" name="rtl"> Manga RTL</label><br>
            <label><input type="checkbox" name="autohide"> Auto-hide UI</label>
            <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn" type="submit">Save</button>
                <button class="btn" type="button" id="setReset">Reset</button>
            </div>
        </form>
    </template>

    <script>(() => {
            "use strict";
            const $ = e => document.getElementById(e), qs = e => document.querySelector(e), qa = e => Array.from(document.querySelectorAll(e));
            const t = $("t"), kpiP = $("kpiP"), kpiZ = $("kpiZ"), fs = $("fs"), thumbToggle = $("thumbToggle"), side = $("side"), thumbs = $("thumbs"), stage = $("stage"), pages = $("pages"), cont = $("cont"), iA = $("iA"), iB = $("iB"), pA = $("pA"), pB = $("pB"), eA = $("eA"), eB = $("eB"), prev = $("prev"), next = $("next"), rng = $("rng"), jmp = $("jmp"), fitBest = $("fitBest"), fitW = $("fitW"), fitH = $("fitH"), fitO = $("fitO"), rot = $("rot"), zM = $("z-"), zP = $("z+"), dbl = $("dbl"), scr = $("scroll"), rtl = $("rtl"), ui = $("ui"), bm = $("bm"), st = $("st"), hlp = $("hlp"), dl = $("dl"), ovHelp = $("ovHelp"), ovSet = $("ovSet"), ovBm = $("ovBm"), ovCmd = $("ovCmd"), helpC = $("helpC"), setC = $("setC"), bmList = $("bmList"), cmdIn = $("cmdIn");

            const S = { page: clamp(BOOK.startPage || 1, 1, PAGES.length), zoom: 1, rot: 0, fit: "best", bestStrategy: 'width', double: false, continuous: false, rtl: (BOOK.readingDirection || "ltr") === "rtl", autohide: true, uiHidden: false, pointers: new Map() };
            function clamp(v, a, b) { return Math.max(a, Math.min(b, v)) }
            function u(u) { try { if (/dropbox\.com/i.test(u)) return u.replace(/[?&]dl=0/g, m => m.replace("dl=0", "raw=1")).replace(/[?&]dl=1/g, m => m.replace("dl=1", "raw=1")) } catch (e) { } return u }
            for (let i = 0; i < PAGES.length; i++)PAGES[i] = u(PAGES[i]);
            const K = k => `neoR:${BOOK.title}:${k}`;
            const persist = () => { try { localStorage.setItem(K("prefs"), JSON.stringify({ page: S.page, zoom: S.zoom, rot: S.rot, fit: S.fit, bestStrategy: S.bestStrategy, double: S.double, continuous: S.continuous, rtl: S.rtl, autohide: S.autohide })) } catch (e) { } };
            const restore = () => { try { const r = localStorage.getItem(K("prefs")); if (r) { const d = JSON.parse(r); delete d.page; delete d.fit; delete d.zoom; Object.assign(S, d) } } catch (e) { } };
            function readLink() { S.page = 1; } // Always start at 1
            function writeLink() { const U = new URL(location.href); U.searchParams.set("page", S.page); history.replaceState({}, "", U); location.hash = `#p=${S.page}` }
            function init() {
                restore(); readLink(); t.textContent = BOOK.title || "Comic Reader"; S.fit = 'best'; S.bestStrategy = 'width'; S.zoom = 1; S.continuous = true; rng.max = String(PAGES.length); thumbsBuild(); bind(); applyToggles(); go(S.page, true);
                (function ensureBestOnce() {
                    let tries = 0;
                    const tick = () => {
                        if (iA.naturalWidth > 0) { S.fit = 'best'; S.bestStrategy = 'width'; fit(); }
                        else if (tries++ < 60) requestAnimationFrame(tick);
                    };
                    requestAnimationFrame(tick);
                })(); updateKPI(); loadTemplates(); autohideSetup()
            }
            function applyToggles() { dbl.setAttribute("aria-pressed", String(!!S.double)); scr.setAttribute("aria-pressed", String(!!S.continuous)); rtl.setAttribute("aria-pressed", String(!!S.rtl)); ui.setAttribute("aria-pressed", String(!!S.uiHidden)) }
            function loadTemplates() { helpC.innerHTML = $("file-help.html").innerHTML; setC.innerHTML = $("file-settings.html").innerHTML; const f = setC.querySelector("#setForm"); f.fit.value = S.fit; f.bestStrategy.value = S.bestStrategy; f.double.checked = S.double; f.continuous.checked = S.continuous; f.rtl.checked = S.rtl; f.autohide.checked = S.autohide; f.addEventListener("submit", e => { e.preventDefault(); S.fit = f.fit.value; S.bestStrategy = f.bestStrategy.value; S.double = f.double.checked; S.continuous = f.continuous.checked; S.rtl = f.rtl.checked; S.autohide = f.autohide.checked; applyToggles(); persist(); ovClose(ovSet); go(S.page, true) }); setC.querySelector("#setReset").addEventListener("click", () => { try { localStorage.removeItem(K("prefs")) } catch (e) { } location.reload() }) }
            function thumbsBuild() { thumbs.innerHTML = ""; const obs = new IntersectionObserver(es => { es.forEach(e => { if (e.isIntersecting) { const im = e.target.querySelector("img"); if (im && im.dataset.src) { im.src = im.dataset.src; im.removeAttribute("data-src") } obs.unobserve(e.target) } }) }, { root: side, rootMargin: "200px" }); const order = [...PAGES].map((_, i) => i + 1); order.forEach(p => { const d = document.createElement("div"); d.className = "th ske"; d.tabIndex = 0; d.setAttribute("role", "button"); d.setAttribute("data-p", p); d.addEventListener("click", () => go(p)); d.addEventListener("keydown", ev => { if (ev.key === "Enter" || ev.key === " ") { ev.preventDefault(); go(p) } }); const im = document.createElement("img"); im.alt = `Thumbnail ${p}`; im.setAttribute("data-src", u(PAGES[p - 1])); d.appendChild(im); thumbs.appendChild(d); obs.observe(d) }); thumbsMark() }
            function thumbsMark() { qa('#thumbs .th').forEach(t => t.removeAttribute('aria-current')); const c = qs(`#thumbs .th[data-p="${S.page}"]`); if (c) c.setAttribute('aria-current', 'true') }
            function nxt(p) { return S.rtl ? p - 1 : p + 1 }
            function prv(p) { return S.rtl ? p + 1 : p - 1 }
            function nextTarget() {
                const N = PAGES.length;
                if (!S.double || S.continuous) return S.rtl ? S.page - 1 : S.page + 1;

                // Cover is single (right). Going forward goes to first full spread.
                if (S.page === 1) return S.rtl ? Math.min(3, N) : Math.min(2, N);

                if (!S.rtl) {
                    // LTR spreads are [even, odd] → left is even (2,4,6,...)
                    const left = (S.page % 2 === 0) ? S.page : S.page - 1;
                    const nextLeft = left + 2;
                    if (nextLeft <= N) return nextLeft;          // next full spread
                    if (left + 1 <= N) return left + 1;          // trailing single last page
                    return N;
                } else {
                    // RTL spreads are [odd, even] → left is odd (3,5,7,...)
                    const left = (S.page % 2 === 1) ? S.page : Math.min(S.page + 1, N);
                    const nextLeft = left - 2;
                    if (nextLeft >= 3) return nextLeft;          // next full spread toward cover
                    return 1;                                    // reach cover
                }
            }

            function prevTarget() {
                const N = PAGES.length;
                if (!S.double || S.continuous) return S.rtl ? S.page + 1 : S.page - 1;

                if (!S.rtl) {
                    // LTR backward by spreads
                    const left = (S.page % 2 === 0) ? S.page : S.page - 1;
                    const prevLeft = left - 2;
                    if (prevLeft >= 2) return prevLeft;          // previous full spread
                    return 1;                                    // cover
                } else {
                    // RTL backward by spreads (away from cover toward the back)
                    if (S.page === 1) return Math.min(3, N);     // from cover to first full spread
                    const left = (S.page % 2 === 1) ? S.page : Math.min(S.page + 1, N);
                    const prevLeft = left + 2;
                    const maxLeft = (N % 2 === 1) ? N : N - 1;   // last odd that can be a left page
                    return Math.min(prevLeft, maxLeft);
                }
            }
            function go(n, instant) { S.page = clamp(n, 1, PAGES.length); rng.value = String(S.page); rng.setAttribute('aria-valuenow', String(S.page)); jmp.value = String(S.page); writeLink(); thumbsMark(); updateKPI(); if (S.continuous) { renderContinuous(); persist(); return } renderPaged(instant); preload(); persist() }
            function updateKPI() { kpiP.textContent = `Page ${S.page}/${PAGES.length}`; kpiZ.textContent = `${Math.round(S.zoom * 100)}%` }
            function preload() { [nxt(S.page), prv(S.page)].forEach(i => { if (i >= 1 && i <= PAGES.length) { const t = new Image(); t.decoding = 'async'; t.src = u(PAGES[i - 1]) } }) }
            function setImg(img, holder, idx) { if (!idx) { holder.hidden = true; return } holder.hidden = false; holder.dataset.e = ''; const src = u(PAGES[idx - 1]); img.alt = `Page ${idx}`; img.src = ''; const I = new Image(); I.decoding = 'async'; I.onload = () => { img.src = src; fit() }; I.onerror = () => { holder.dataset.e = '1'; holder.querySelector('.err').innerHTML = `<div>Failed to load p.${idx}. <button class="btn" data-retry="${idx}">Retry</button></div>` }; I.src = src; I.decode?.().catch(() => { }) }
            function renderPaged(instant) { document.body.classList.remove('mode-cont'); cont.hidden = true; pages.hidden = false; pB.hidden = !S.double; const [A, B] = pair(S.page); setImg(iA, pA, A); if (S.double) setImg(iB, pB, B); fit(instant) }
            function renderContinuous() { document.body.classList.add('mode-cont'); pages.hidden = true; pages.style.transform = 'none'; cont.hidden = false; cont.innerHTML = ''; const obs = new IntersectionObserver(es => { es.forEach(e => { if (e.isIntersecting) { const im = e.target.querySelector('img'); if (im && im.dataset.src) { im.src = im.dataset.src; im.removeAttribute('data-src') } } }) }, { root: cont, rootMargin: '200px' }); const order = [...PAGES].map((_, i) => i + 1); order.forEach(p => { const f = document.createElement('figure'); f.innerHTML = `<img alt="Page ${p}" data-src="${u(PAGES[p - 1])}">`; cont.appendChild(f); obs.observe(f) }); requestAnimationFrame(() => { const target = cont.children[S.page - 1]; if (target) target.scrollIntoView({ block: 'start' }) }) }
            function pair(p) {
                const N = PAGES.length;

                // Single-page mode
                if (!S.double) return [p, null];

                // Cover is always single on the right (both LTR and RTL)
                if (p === 1) return [null, 1];

                if (!S.rtl) {
                    // LTR spreads: [even, odd] => [2,3], [4,5], ...
                    if (p % 2 === 0) {
                        // p even → p on the left
                        const L = p;
                        const R = (p + 1 <= N) ? p + 1 : null;
                        return [L, R];
                    } else {
                        // p odd → p on the right
                        const L = p - 1;
                        const R = p;
                        return [L, R];
                    }
                } else {
                    // RTL (manga) spreads: [odd, even] => [3,2], [5,4], ...
                    if (p % 2 === 0) {
                        // p even → p on the right
                        const L = (p + 1 <= N) ? p + 1 : null;
                        const R = p;
                        return [L, R];
                    } else {
                        // p odd → p on the right
                        const L = (p + 1 <= N) ? p + 1 : null;
                        const R = p - 1 >= 1 ? p - 1 : null;
                        // Prefer the canonical pair [p, p-1] when possible
                        return [p, (p - 1 >= 1 ? p - 1 : null)];
                    }
                }
            }


            // ---- Fixed fit logic (Best/Original) ----
            function fit() {
                const vp = stage.getBoundingClientRect();
                const imgs = [iA, S.double ? iB : null].filter(Boolean);
                let w = 0, h = 0;
                imgs.forEach(im => { if (!im.naturalWidth) return; w += im.naturalWidth; h = Math.max(h, im.naturalHeight); });
                const rotSwap = (S.rot % 180) !== 0;
                const natW = rotSwap ? h : w, natH = rotSwap ? w : h;
                const widthFit = vp.width / (natW || vp.width);
                const heightFit = vp.height / (natH || vp.height);

                let s = S.zoom;
                switch (S.fit) {
                    case 'width': s = widthFit; break;
                    case 'height': s = heightFit; break;
                    case 'best': {
                        const strat = S.bestStrategy || 'contain';
                        if (strat === 'width') s = widthFit;
                        else if (strat === 'height') s = heightFit;
                        else if (strat === 'smart') s = (natH / natW >= 1.1) ? widthFit : Math.min(widthFit, heightFit);
                        else s = Math.min(widthFit, heightFit); // contain
                        break;
                    }
                    case 'orig':
                    default:
                        // orig uses current S.zoom; callers set S.zoom=1 when entering orig
                        s = S.zoom;
                        break;
                }
                S.zoom = s;
                pages.style.transform = `rotate(${S.rot}deg) scale(${s})`; // rotate then scale
                updateKPI();
            }

            function doZoom(mult) { S.fit = 'orig'; S.zoom = clamp(S.zoom * mult, .1, 8); fit(); persist() }

            function bind() {
                prev.addEventListener('click', () => go(prevTarget()));
                next.addEventListener('click', () => go(nextTarget()));
                rng.addEventListener('input', () => go(parseInt(rng.value, 10)));
                jmp.addEventListener('change', () => go(clamp(parseInt(jmp.value || '1', 10), 1, PAGES.length)));

                fitBest.addEventListener('click', () => { S.fit = 'best'; fit(); persist() });
                fitW.addEventListener('click', () => { S.fit = 'width'; fit(); persist() });
                fitH.addEventListener('click', () => { S.fit = 'height'; fit(); persist() });
                // ---- Fixed: Original now forces 1:1 zoom ----
                fitO.addEventListener('click', () => { S.fit = 'orig'; S.zoom = 1; fit(); persist() });

                rot.addEventListener('click', () => { S.rot = (S.rot + 90) % 360; fit(); persist() });
                zP.addEventListener('click', () => doZoom(1.1));
                zM.addEventListener('click', () => doZoom(1 / 1.1));
                dbl.addEventListener('click', () => { S.double = !S.double; dbl.setAttribute('aria-pressed', String(S.double)); persist(); go(S.page, true) });
                scr.addEventListener('click', () => { S.continuous = !S.continuous; scr.setAttribute('aria-pressed', String(S.continuous)); persist(); go(S.page, true) });
                rtl.addEventListener('click', () => { S.rtl = !S.rtl; rtl.setAttribute('aria-pressed', String(S.rtl)); thumbsBuild(); persist(); go(S.page, true) });
                ui.addEventListener('click', () => { document.body.classList.toggle('chrome-hidden'); S.uiHidden = document.body.classList.contains('chrome-hidden'); ui.setAttribute('aria-pressed', String(S.uiHidden)); persist() });
                thumbToggle.addEventListener('click', () => { const h = side.hasAttribute('hidden'); if (h) side.removeAttribute('hidden'); else side.setAttribute('hidden', ''); thumbToggle.setAttribute('aria-pressed', String(!h)) });
                fs.addEventListener('click', () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => { }); else document.exitFullscreen().catch(() => { }) });
                dl.addEventListener('click', () => { const idx = S.double ? pair(S.page)[0] : S.page; const a = document.createElement('a'); a.href = u(PAGES[idx - 1]); a.download = `page-${idx}.jpg`; document.body.appendChild(a); a.click(); a.remove() });
                pages.addEventListener('click', e => { const r = e.target.closest('[data-retry]'); if (!r) return; const n = parseInt(r.getAttribute('data-retry'), 10); setImg(n % 2 ? iA : iB, n % 2 ? pA : pB, n) });
                hlp.addEventListener('click', () => ovOpen(ovHelp));
                st.addEventListener('click', () => ovOpen(ovSet));
                bm.addEventListener('click', () => { bmRender(); ovOpen(ovBm) });
                document.addEventListener('click', e => { const c = e.target.closest('[data-close]'); if (c) ovClose($(c.getAttribute('data-close').slice(1))) });
            }

            function ovOpen(o) { o.setAttribute('open', '') }
            function ovClose(o) { o.removeAttribute('open') }
            function bmKey() { return K('bmarks') }
            function bmGet() { try { return JSON.parse(localStorage.getItem(bmKey()) || '[]') } catch (e) { return [] } }
            function bmSet(v) { try { localStorage.setItem(bmKey(), JSON.stringify(v)) } catch (e) { } }
            function bmToggle(p) { const b = bmGet(); const i = b.indexOf(p); if (i >= 0) b.splice(i, 1); else b.push(p); bmSet(b); bmRender() }
            function bmRender() { const b = bmGet().sort((a, b) => a - b); bmList.innerHTML = ''; if (!b.length) { bmList.innerHTML = '<p style="opacity:.8">No bookmarks yet.</p>'; return } b.forEach(p => { const d = document.createElement('div'); d.className = 'grp'; d.innerHTML = `<span class="pill">p.${p}</span><button class="btn" data-go="${p}">Open</button><button class="btn" data-del="${p}">Remove</button>`; bmList.appendChild(d) }) }
            bmList.addEventListener('click', e => { const g = e.target.closest('[data-go]'); if (g) { go(parseInt(g.getAttribute('data-go'), 10)); ovClose(ovBm) } const d = e.target.closest('[data-del]'); if (d) { const p = parseInt(d.getAttribute('data-del'), 10); bmSet(bmGet().filter(x => x !== p)); bmRender() } });

            document.addEventListener('keydown', e => {
                if (e.target && ['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
                switch (e.key) {
                    case 'ArrowLeft':  go(S.rtl ? nextTarget() : prevTarget()); break;
                    case 'ArrowRight': go(S.rtl ? prevTarget() : nextTarget()); break;
                    case '[': go(clamp(S.page - 10, 1, PAGES.length)); break;
                    case ']': go(clamp(S.page + 10, 1, PAGES.length)); break;
                    case '+': case '=': doZoom(1.1); break;
                    case '-': doZoom(1 / 1.1); break;
                    case '0': S.fit = 'width'; fit(); persist(); break;
                    case '9': S.fit = 'height'; fit(); persist(); break;
                    case '8': S.fit = 'orig'; S.zoom = 1; fit(); persist(); break;
                    case 'F': case 'f': fs.click(); break;
                    case 'T': case 't': thumbToggle.click(); break;
                    case 'C': case 'c': scr.click(); break;
                    case 'D': case 'd': dbl.click(); break;
                    case 'M': case 'm': rtl.click(); break;
                    case 'R': case 'r': rot.click(); break;
                    case 'B': case 'b': bmToggle(S.page); break;
                    case 'H': case 'h': hlp.click(); break;
                    case 'G': case 'g': ui.click(); break;
                    case '/': ovOpen(ovCmd); cmdIn.value = ''; cmdIn.focus(); break;
                }
            });

            cmdIn.addEventListener('keydown', e => { if (e.key === 'Enter') { const v = parseInt(cmdIn.value, 10); if (v) { ovClose(ovCmd); go(v) } } });

            let dragging = false, last = { x: 0, y: 0 };
            stage.addEventListener('pointerdown', e => { dragging = true; last.x = e.clientX; last.y = e.clientY; stage.setPointerCapture(e.pointerId); S.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY }) });
            stage.addEventListener('pointermove', e => {
                if (dragging) { const dx = e.clientX - last.x, dy = e.clientY - last.y; stage.scrollLeft -= dx; stage.scrollTop -= dy; last.x = e.clientX; last.y = e.clientY }
                if (S.pointers.has(e.pointerId)) {
                    S.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
                    if (S.pointers.size === 2) {
                        const a = [...S.pointers.values()];
                        const d = Math.hypot(a[0].x - a[1].x, a[0].y - a[1].y);
                        if (!stage._pd) stage._pd = d;
                        const r = d / stage._pd;
                        S.fit = 'orig'; S.zoom = clamp(S.zoom * r, .1, 8); stage._pd = d; fit();
                    }
                }
            });
            stage.addEventListener('pointerup', e => { dragging = false; S.pointers.delete(e.pointerId); stage._pd = null });
            // ---- Fixed: dblclick toggles, orig -> zoom=1
            stage.addEventListener('dblclick', () => {
                if (S.fit === 'orig') { S.fit = 'best'; }
                else { S.fit = 'orig'; S.zoom = 1; }
                fit(); persist();
            });
            stage.addEventListener('wheel', e => { if (e.ctrlKey) { e.preventDefault(); doZoom(e.deltaY > 0 ? 1 / 1.1 : 1.1) } }, { passive: false });
            let idle = null; function autohideSetup() { if (!S.autohide) return; const wake = () => { document.body.classList.remove('chrome-hidden'); clearTimeout(idle); idle = setTimeout(() => document.body.classList.add('chrome-hidden'), 2000) };['mousemove', 'keydown', 'pointerdown', 'wheel', 'touchstart'].forEach(ev => document.addEventListener(ev, wake, { passive: true })); wake() }
            window.addEventListener('resize', () => fit(true));
            init();
            window.__READER__ = { S, nxt, prv, pair, norm: u, go };
        })();</script>
</body>

</html>